<!DOCTYPE html>
<html lang="en" class="light-style" dir="ltr" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />
  <title>EduPulse - Course List</title>
  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="https://demos.themeselection.com/materio-bootstrap-html-admin-template/assets/img/favicon/favicon.ico">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/remixicon@2.5.0/fonts/remixicon.css" rel="stylesheet">

  <!-- Core CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/plyr/3.7.8/plyr.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/perfect-scrollbar/1.5.5/css/perfect-scrollbar.min.css" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/course_details.css') }}">
</head>

<body>
  <!-- Layout wrapper -->
  <div class="layout-wrapper layout-content-navbar">
    <div class="layout-container">
      <!-- Menu Sidebar -->
<!-- Menu Sidebar -->
<aside id="layout-menu" class="layout-menu menu-vertical">
  <div class="app-brand demo">
    <a href="index.html" class="app-brand-link">
      <span class="app-brand-logo demo">
        <svg width="30" height="24" viewBox="0 0 250 196" fill="none" xmlns="http://www.w3.org/2000/svg">
          <!-- Your SVG logo path here -->
        </svg>
      </span>
      <span class="app-brand-text demo menu-text fw-semibold ms-2">EduPulse</span>
    </a>
    <a href="javascript:void(0);" class="layout-menu-toggle menu-link text-large ms-auto" aria-label="Close menu">
      <i class="ri-close-line ri-lg"></i>
    </a>
  </div>

  <div class="menu-divider"></div>

  <ul class="menu-inner">
    <!-- Academy Menu -->
    <li class="menu-item active">
      <a href="javascript:void(0);" class="menu-link menu-toggle">
        <div class="menu-icon-wrapper">
          <i class="menu-icon tf-icons ri-graduation-cap-line"></i>
        </div>
        <div class="menu-title">Academy</div>
        <i class="menu-arrow ri-arrow-right-s-line"></i>
      </a>
<ul class="menu-sub">
    <li class="menu-item active">
        <a href="{{ url_for('main.app_academy_dashboard') }}" class="menu-link">
            <div class="menu-bullet">
                <span></span>
            </div>
            <div class="menu-text">Dashboard</div>
        </a>
    </li>
    <li class="menu-item">
        <a href="{{ url_for('main.app_academy_course') }}" class="menu-link">
            <div class="menu-bullet">
                <span></span>
            </div>
            <div class="menu-text">Courses</div>
        </a>
    </li>
</ul>
    </li>

    <!-- Users Menu -->
    <li class="menu-item">
      <a href="javascript:void(0);" class="menu-link menu-toggle">
        <div class="menu-icon-wrapper">
          <i class="menu-icon tf-icons ri-user-line"></i>
        </div>
        <div class="menu-title">Students</div>
        <i class="menu-arrow ri-arrow-right-s-line"></i>
      </a>
      <ul class="menu-sub">
        <li class="menu-item">
          <a href="{{ url_for('main.app_student_list') }}" class="menu-link">
            <div class="menu-bullet">
              <span></span>
            </div>
            <div class="menu-text">Student List</div>
          </a>
        </li>
      </ul>
    </li>
  </ul>

</aside>

      <!-- Layout page -->
      <div class="layout-page">
        <!-- Navbar -->
        <nav class="layout-navbar navbar navbar-expand-lg align-items-center bg-navbar-theme" id="layout-navbar">
          <div class="container-fluid">
            <div class="layout-menu-toggle navbar-nav align-items-xl-center me-3 me-xl-0 d-xl-none">
              <a class="nav-item nav-link px-0 me-xl-4" href="javascript:void(0)" aria-label="Toggle menu">
                <i class="ri-menu-fill ri-lg"></i>
              </a>
            </div>

            <div class="navbar-nav-right d-flex align-items-center" id="navbar-collapse">
              <ul class="navbar-nav flex-row align-items-center ms-auto">
                <!-- Style Switcher -->
                <li class="nav-item dropdown-style-switcher dropdown me-2 me-xl-0">
                  <a class="nav-link btn btn-text-secondary rounded-pill btn-icon dropdown-toggle hide-arrow" href="javascript:void(0);" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Theme switcher">
                    <i class="ri-sun-line ri-lg light-icon"></i>
                    <i class="ri-moon-line ri-lg dark-icon" style="display: none;"></i>
                  </a>
                  <ul class="dropdown-menu dropdown-menu-end dropdown-styles">
                    <li>
                      <a class="dropdown-item theme-item" href="javascript:void(0);" data-theme="light">
                        <i class="ri-sun-line me-2"></i>
                        <span class="align-middle">Light</span>
                      </a>
                    </li>
                    <li>
                      <a class="dropdown-item theme-item" href="javascript:void(0);" data-theme="dark">
                        <i class="ri-moon-line me-2"></i>
                        <span class="align-middle">Dark</span>
                      </a>
                    </li>
                  </ul>
                </li>

                <!-- User -->
                <li class="nav-item navbar-dropdown dropdown-user dropdown">
                  <a class="nav-link dropdown-toggle hide-arrow p-0" href="javascript:void(0);" data-bs-toggle="dropdown" aria-expanded="false">
                    <div class="avatar avatar-online">
                      <img src="https://demos.themeselection.com/materio-bootstrap-html-admin-template/assets/img/avatars/1.png" alt="User avatar" class="w-px-40 h-auto rounded-circle">
                    </div>
                  </a>
                  <ul class="dropdown-menu dropdown-menu-end mt-3 py-2">
                    {% if 'email' in session %}
                    <li>
                      <a class="dropdown-item" href="#">
                        <div class="d-flex align-items-center">
                          <div class="flex-shrink-0 me-2">
                            <div class="avatar avatar-online">
                              <img src="https://demos.themeselection.com/materio-bootstrap-html-admin-template/assets/img/avatars/1.png" alt="User avatar" class="w-px-40 h-auto rounded-circle">
                            </div>
                          </div>
                          <div class="flex-grow-1">
                            <h6 class="mb-0">John Doe</h6>
                            <small class="text-muted">Admin</small>
                          </div>
                        </div>
                      </a>
                    </li>
                    <li>
                      <div class="dropdown-divider"></div>
                    </li>
                    <li>
                      <a class="dropdown-item" href="{{ url_for('main.pages_profile_student') }}">
                        <i class="ri-user-3-line me-2"></i>
                        <span class="align-middle">My Profile</span>
                      </a>
                    </li>
                    <li>
                      <div class="dropdown-divider"></div>
                    </li>
                    <li>
                      <a class="dropdown-item" href="{{ url_for('main.logout') }}">
                        <i class="fas fa-sign-out-alt me-2"></i>
                        <span class="align-middle">Logout</span>
                      </a>
                    </li>
                    {% else %}
                    <li>
                      <div class="dropdown-item">
                        <div class="d-flex flex-column gap-2">
                          <a href="{{ url_for('main.login') }}" class="btn btn-outline-primary w-100">
                            <i class="fas fa-sign-in-alt me-1"></i> Login
                          </a>
                          <a href="{{ url_for('main.signup') }}" class="btn btn-primary w-100">
                            <i class="fas fa-user-plus me-1"></i> Sign Up
                          </a>
                        </div>
                      </div>
                    </li>
                    {% endif %}
                  </ul>
                </li>
              </ul>
            </div>
          </div>
        </nav>

        <!-- Content wrapper -->
        <div class="content-wrapper">

          <!-- Content -->
          <div class="container-xxl flex-grow-1 container-p-y">
            <div class="app-academy">
              <!-- Hero Section -->
              <div class="card p-0 mb-6">
                <div class="card-body d-flex flex-column flex-md-row justify-content-between p-0 pt-6">
                  <div class="app-academy-md-25 card-body py-0 pt-6 ps-12">
                    <img src="https://demos.themeselection.com/materio-bootstrap-html-admin-template/assets/img/illustrations/bulb-light.png" class="img-fluid app-academy-img-height scaleX-n1-rtl" alt="Bulb in hand" data-app-light-img="illustrations/bulb-light.png" data-app-dark-img="illustrations/bulb-dark.png" height="90" />
                  </div>
                  <div class="app-academy-md-50 card-body d-flex align-items-md-center flex-column text-md-center mb-6 py-6">
                    <h1 class="card-title mb-4 lh-lg px-md-12 h4 text-heading">
                      Education, talents, and career<br> opportunities.
                      <span class="text-primary text-nowrap">All in one place</span>.
                    </h1>
                    <p class="mb-4 px-0 px-md-2">
                      Grow your skill with the most reliable online courses and certifications in<br> marketing, information technology, programming, and data science.
                    </p>
                    <div class="d-flex align-items-center justify-content-between app-academy-md-80">
                      <input type="search" placeholder="Find your course" class="form-control form-control-sm me-4" aria-label="Search courses" />
                      <button type="submit" class="btn btn-primary btn-icon" aria-label="Search"><i class="ri-search-line ri-22px"></i></button>
                    </div>
                  </div>
                  <div class="app-academy-md-25 d-flex align-items-end justify-content-end">
                    <img src="https://demos.themeselection.com/materio-bootstrap-html-admin-template/assets/img/illustrations/pencil-rocket.png" alt="Pencil rocket" height="188" class="scaleX-n1-rtl" />
                  </div>
                </div>
              </div>

              <!-- My Courses Section -->
              <div class="card mb-6">
                <div class="card-header d-flex flex-wrap justify-content-between gap-4">
                  <div class="card-title mb-0 me-1">
                    <h2 class="mb-0">Courses</h2>
                  </div>
                  <div class="d-flex justify-content-md-end align-items-center column-gap-6">
                    <label for="courseFilter" class="visually-hidden">Filter courses</label>
                    <select id="courseFilter" class="form-select form-select-sm">
                      <option value="all courses">All Courses</option>
                      <option value="ui/ux">UI/UX</option>
                      <option value="seo">SEO</option>
                      <option value="web">Web</option>
                      <option value="music">Music</option>
                      <option value="painting">Painting</option>
                    </select>
                  </div>
                </div>
                <div class="card-body mt-1">
                  <div class="row gy-6 mb-6">

<!-- Replace the static course cards with this dynamic container -->
<div class="card-body mt-1">
  <div class="row gy-6 mb-6" id="courses-container">
    <!-- Courses will be loaded here via AJAX -->
  </div>
  
  <!-- Add loading indicator -->
  <div id="loading-indicator" class="text-center py-4">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>
  
  <!-- Add pagination controls -->
  <div class="d-flex justify-content-center mt-4">
    <nav>
      <ul class="pagination" id="pagination-controls">
        <li class="page-item disabled" id="prev-page">
          <a class="page-link" href="#" tabindex="-1">Previous</a>
        </li>
        <li class="page-item active"><a class="page-link" href="#">1</a></li>
        <li class="page-item" id="next-page">
          <a class="page-link" href="#">Next</a>
        </li>
      </ul>
    </nav>
  </div>
</div>
                      <!-- Overlay -->
    <div class="layout-overlay layout-menu-toggle"></div>
  </div>

  <!-- Core JS -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/plyr/3.7.8/plyr.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/perfect-scrollbar/1.5.5/perfect-scrollbar.min.js"></script>
  <script src="{{ url_for('static', filename='js/app.js') }}"></script>
<script>
$(document).ready(function() {
  let currentPage = 1;
  const coursesPerPage = 6;
  
   const isLoggedIn = {% if 'email' in session %}true{% else %}false{% endif %};
  loadCourses(currentPage);
  
  $('#next-page').click(function(e) {
    e.preventDefault();
    currentPage++;
    loadCourses(currentPage);
  });
  
  $('#prev-page').click(function(e) {
    e.preventDefault();
    if (currentPage > 1) {
      currentPage--;
      loadCourses(currentPage);
    }
  });
  
  $('#courseFilter').change(function() {
    currentPage = 1;
    loadCourses(currentPage);
  });
  
  $('button[aria-label="Search"]').click(function(e) {
    e.preventDefault();
    currentPage = 1;
    loadCourses(currentPage);
  });
  
  $('input[aria-label="Search courses"]').keypress(function(e) {
    if (e.which === 13) { // Enter key
      e.preventDefault();
      currentPage = 1;
      loadCourses(currentPage);
    }
  });
});

function loadCourses(page) {
  console.log("Loading courses, page:", page); // Debug log
  const filterValue = $('#courseFilter').val();
  const searchQuery = $('input[aria-label="Search courses"]').val();
  
  $('#loading-indicator').show();
  $('#courses-container').empty();
  
  $.ajax({
    url: '/api/courses',
    type: 'GET',
    data: {
      page: page,
      filter: filterValue,
      search: searchQuery
    },
    success: function(response) {
      console.log("API response:", response);
      if (response.courses && response.courses.length > 0) {
        renderCourses(response);
      } else {
        $('#courses-container').html(
          '<div class="col-12 text-center py-4">No courses found. Try changing your search criteria.</div>'
        );
      }
      updatePagination(response);
    },
    error: function(xhr, status, error) {
      console.error("AJAX error:", status, error);
      $('#courses-container').html(
        '<div class="col-12 text-center text-danger py-4">Error loading courses. Please try again.</div>'
      );
    },
    complete: function() {
      $('#loading-indicator').hide();
    }
  });
}

function renderCourses(data) {
  console.log("Rendering courses:", data); 
  const container = $('#courses-container');
  
  if (!data || !data.courses) {
    console.error("Invalid data format:", data);
    container.html('<div class="col-12 text-center text-danger py-4">Invalid data received from server</div>');
    return;
  }
  
  if (data.courses.length === 0) {
    container.html('<div class="col-12 text-center py-4">No courses found matching your criteria.</div>');
    return;
  }
  
  data.courses.forEach(course => {
    const courseCard = `
      <div class="col-sm-6 col-lg-4 mb-4">
        <div class="card shadow-none border p-2 h-100">
          <div class="rounded-2 text-center mb-3">
            <img class="img-fluid" src="${course.image_url || 'https://demos.themeselection.com/materio-bootstrap-html-admin-template/assets/img/pages/app-academy-tutor-1.png'}" alt="${course.title}">
          </div>
          <div class="card-body p-4 pt-2">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <span class="badge rounded-pill bg-label-primary">Web</span>
              <p class="d-flex align-items-center justify-content-center fw-medium gap-1 mb-0">
                4.4 <span class="text-warning"><i class="ri-star-s-fill ri-24px me-1"></i></span>
                <span class="fw-normal">(1.23k)</span>
              </p>
            </div>
            <h3 class="h5">${course.title}</h3>
            <p class="mt-1">${course.description}</p>
            <p class="d-flex align-items-center mb-1">
              <i class="ri-time-line ri-20px me-1"></i>30 minutes
            </p>
            <form class="enroll-form" data-course-id="${course.id}">
              <button type="submit" class="w-100 btn btn-primary">
                <i class="ri-user-add-line me-2"></i>Enroll
              </button>
            </form>
          </div>
        </div>
      </div>
    `;
    container.append(courseCard);
  });

$('.enroll-form').off('submit').on('submit', function(e) {
  e.preventDefault();
  const form = $(this);
  const courseId = form.data('course-id');
  
  if (typeof isLoggedIn !== 'undefined' && !isLoggedIn) {
    if (confirm('You need to login to enroll in courses. Would you like to login now?')) {
      window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname);
    }
    return;
  }
  
  console.log("Enrolling in course:", courseId);
  
  $.ajax({
    url: '/enroll/' + courseId,
    method: 'POST',
    success: function(response) {
      console.log("Enrollment success:", response);
      form.find('button')
        .prop('disabled', true)
        .html('<i class="ri-check-line me-2"></i>Enrolled')
        .removeClass('btn-primary')
        .addClass('btn-success');
      
      if (response.course_url) {
        setTimeout(() => {
          window.location.href = response.course_url;
        }, 1500);
      } else {
        alert(response.message || 'Successfully enrolled in the course!');
      }
    },
    error: function(xhr) {
      console.error("Enrollment error:", xhr);
      if (xhr.status === 401) {
        if (confirm('Please login to enroll in courses. Would you like to login now?')) {
          window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname);
        }
      } else {
        alert('Error: ' + (xhr.responseJSON?.error || xhr.responseText || 'Unknown error occurred'));
      }
    }
  });
});
 
}

function updatePagination(data) {
  console.log("Updating pagination:", data); 
  const pagination = $('#pagination-controls');
  const currentPage = data.current_page;
  const totalPages = data.pages;
  
  pagination.find('.page-item:not(#prev-page):not(#next-page)').remove();
  
  for (let i = 1; i <= totalPages; i++) {
    const active = i === currentPage ? 'active' : '';
    pagination.find('#prev-page').after(
      `<li class="page-item ${active}"><a class="page-link" href="#">${i}</a></li>`
    );
  }
  
  // Update prev/next button states
  $('#prev-page').toggleClass('disabled', currentPage === 1);
  $('#next-page').toggleClass('disabled', currentPage === totalPages || totalPages === 0);
  
  pagination.find('.page-item:not(#prev-page):not(#next-page)').off('click').on('click', function(e) {
    e.preventDefault();
    const page = parseInt($(this).text());
    console.log("Page clicked:", page); 
    loadCourses(page);
  });
}
</script>
</body>
</html>